import javax.swing.*;
import javax.swing.border.EmptyBorder;
import java.awt.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Enumeration;

 //Lớp TenantIssue - Giao diện quản lý và báo cáo sự cố dành cho Người thuê.
 //Chức năng: Hiển thị danh sách sự cố, tạo báo cáo mới với giao diện hiện đại.

public class TenantIssue extends JPanel {

    // CẤU HÌNH GIAO DIỆN (THEME)
    private final Color PRIMARY_PINK = new Color(255, 110, 157);
    private final Color SOFT_PINK_BG = new Color(255, 242, 246);
    private final String CUTE_FONT = "Segoe UI";
    private final Color BG_COLOR = new Color(252, 252, 252);

    private JPanel mainListPanel;

    public TenantIssue() {
        initComponents();
    }

    //Khởi tạo các thành phần giao diện chính

    private void initComponents() {
        setLayout(new BorderLayout(20, 10));
        setBackground(BG_COLOR);
        setBorder(new EmptyBorder(25, 35, 25, 35));

        // 1. Phần tiêu đề và Nút thêm sự cố
        add(createHeader(), BorderLayout.NORTH);

        // 2. Danh sách hiển thị các thẻ sự cố (Sử dụng ScrollPane)
        mainListPanel = new JPanel();
        mainListPanel.setLayout(new BoxLayout(mainListPanel, BoxLayout.Y_AXIS));
        mainListPanel.setOpaque(false);

        JScrollPane scrollPane = new JScrollPane(mainListPanel);
        scrollPane.setBorder(null);
        scrollPane.setOpaque(false);
        scrollPane.getViewport().setOpaque(false);

        add(scrollPane, BorderLayout.CENTER);
    }

    //Tạo thanh Header chứa tiêu đề trang và nút chức năng

    private JPanel createHeader() {
        JPanel header = new JPanel(new BorderLayout());
        header.setOpaque(false);

        JLabel lblTitle = new JLabel("Sự cố");
        lblTitle.setFont(new Font(CUTE_FONT, Font.BOLD, 28));

        JButton btnAdd = createStyledAddButton("+ Báo cáo sự cố");
        btnAdd.addActionListener(e -> showReportPopup());

        header.add(lblTitle, BorderLayout.WEST);
        header.add(btnAdd, BorderLayout.EAST);
        return header;
    }

    //Hiển thị cửa sổ Popup để nhập báo cáo sự cố mới

    private void showReportPopup() {
        JDialog dialog = new JDialog();
        dialog.setModal(true);
        dialog.setSize(560, 680);
        dialog.setLocationRelativeTo(null);
        dialog.getContentPane().setBackground(Color.WHITE);

        JPanel rootPanel = new JPanel();
        rootPanel.setLayout(new BoxLayout(rootPanel, BoxLayout.Y_AXIS));
        rootPanel.setBackground(Color.WHITE);
        rootPanel.setBorder(new EmptyBorder(25, 40, 25, 40));

        // Tiêu đề Popup
        JLabel popTitle = new JLabel("Báo cáo sự cố mới");
        popTitle.setFont(new Font(CUTE_FONT, Font.BOLD, 22));
        popTitle.setAlignmentX(Component.LEFT_ALIGNMENT);
        rootPanel.add(popTitle);
        rootPanel.add(Box.createVerticalStrut(25));

        // Phần chọn Loại sự cố
        addFormLabel(rootPanel, "Loại sự cố");
        ButtonGroup typeGroup = new ButtonGroup();
        rootPanel.add(createOptionGroup(new String[]{"Điện", "Nước", "Cửa", "Khác"}, typeGroup, 95));
        rootPanel.add(Box.createVerticalStrut(20));

        // Phần chọn Mức độ
        addFormLabel(rootPanel, "Mức độ khẩn cấp");
        ButtonGroup levelGroup = new ButtonGroup();
        rootPanel.add(createOptionGroup(new String[]{"Thấp", "Trung bình", "Khẩn cấp"}, levelGroup, 120));
        rootPanel.add(Box.createVerticalStrut(20));

        // Phần nhập mô tả
        addFormLabel(rootPanel, "Mô tả chi tiết");
        JTextArea txtDescription = new JTextArea(5, 20);
        txtDescription.setFont(new Font(CUTE_FONT, Font.PLAIN, 15));
        txtDescription.setLineWrap(true);
        txtDescription.setWrapStyleWord(true);

        JScrollPane textScroll = new JScrollPane(txtDescription);
        textScroll.setAlignmentX(Component.LEFT_ALIGNMENT);
        textScroll.setBorder(BorderFactory.createLineBorder(new Color(235, 235, 235), 1, true));
        rootPanel.add(textScroll);
        rootPanel.add(Box.createVerticalStrut(30));

        // Nút Gửi báo cáo
        JButton btnSend = createActionButton("Gửi báo cáo");
        btnSend.addActionListener(e -> {
            if (txtDescription.getText().trim().isEmpty()) return;

            String currentTime = LocalDateTime.now().format(DateTimeFormatter.ofPattern("HH:mm - dd/MM/yyyy"));
            addNewIssueCard(getSelectedButtonText(typeGroup), txtDescription.getText(), currentTime, getSelectedButtonText(levelGroup));
            dialog.dispose();
        });

        rootPanel.add(btnSend);
        dialog.add(rootPanel);
        dialog.setVisible(true);
    }

    //Thêm một thẻ sự cố mới vào danh sách hiển thị

    private void addNewIssueCard(String type, String desc, String time, String level) {
        mainListPanel.add(createIssueCard(type, desc, time, level), 0);
        mainListPanel.add(Box.createVerticalStrut(12), 1);
        mainListPanel.revalidate();
        mainListPanel.repaint();
    }

    //Tạo một Card hiển thị thông tin sự cố

    private JPanel createIssueCard(String type, String desc, String time, String level) {
        JPanel card = new JPanel(new BorderLayout(15, 8)) {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2 = (Graphics2D) g.create();
                g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2.setColor(Color.WHITE);
                g2.fillRoundRect(0, 0, getWidth(), getHeight(), 20, 20); // Bo góc Card 20px
                g2.dispose();
            }
        };
        card.setOpaque(false);
        card.setBorder(new EmptyBorder(15, 20, 15, 20));
        card.setMaximumSize(new Dimension(1000, 120));

        // Dòng trên cùng: Loại và Mức độ
        JPanel topRow = new JPanel(new BorderLayout());
        topRow.setOpaque(false);

        JLabel lblType = new JLabel(type.toUpperCase());
        lblType.setFont(new Font(CUTE_FONT, Font.BOLD, 14));
        lblType.setForeground(PRIMARY_PINK);

        JLabel lblLevel = new JLabel(level);
        lblLevel.setFont(new Font(CUTE_FONT, Font.BOLD, 13));
        if (level.equals("Khẩn cấp")) lblLevel.setForeground(new Color(255, 80, 80));
        else if (level.equals("Trung bình")) lblLevel.setForeground(new Color(255, 160, 0));
        else lblLevel.setForeground(new Color(80, 180, 80));

        topRow.add(lblType, BorderLayout.WEST);
        topRow.add(lblLevel, BorderLayout.EAST);

        // Nội dung mô tả
        JLabel lblDesc = new JLabel("<html><body style='width: 600px; color: #444; font-family:" + CUTE_FONT + "; font-size: 14pt;'>" + desc + "</body></html>");

        // Thời gian báo cáo
        JLabel lblTime = new JLabel(time);
        lblTime.setForeground(Color.LIGHT_GRAY);
        lblTime.setFont(new Font(CUTE_FONT, Font.PLAIN, 10));

        card.add(topRow, BorderLayout.NORTH);
        card.add(lblDesc, BorderLayout.CENTER);
        card.add(lblTime, BorderLayout.SOUTH);

        return card;
    }

    //CÁC HÀM HỖ TRỢ VẼ GIAO DIỆN (HELPER METHODS)

    private JButton createStyledAddButton(String text) {
        JButton btn = new JButton(text) {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2 = (Graphics2D) g.create();
                g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2.setColor(PRIMARY_PINK);
                g2.fillRoundRect(4, 4, getWidth() - 8, 32, 15, 15);
                g2.setColor(Color.WHITE);
                g2.setFont(new Font(CUTE_FONT, Font.BOLD, 13));
                FontMetrics fm = g2.getFontMetrics();
                g2.drawString(getText(), (getWidth() - fm.stringWidth(getText())) / 2, (getHeight() + fm.getAscent()) / 2 - 2);
                g2.dispose();
            }
        };
        btn.setPreferredSize(new Dimension(145, 40));
        btn.setContentAreaFilled(false);
        btn.setBorderPainted(false);
        btn.setFocusPainted(false);
        btn.setCursor(new Cursor(Cursor.HAND_CURSOR));
        return btn;
    }

    private JButton createActionButton(String text) {
        JButton btn = new JButton(text) {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2 = (Graphics2D) g.create();
                g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2.setColor(PRIMARY_PINK);
                g2.fillRoundRect(0, 0, getWidth(), getHeight(), 15, 15);
                g2.setColor(Color.WHITE);
                g2.setFont(new Font(CUTE_FONT, Font.BOLD, 16));
                FontMetrics fm = g2.getFontMetrics();
                g2.drawString(getText(), (getWidth() - fm.stringWidth(getText())) / 2, (getHeight() + fm.getAscent()) / 2 - 2);
                g2.dispose();
            }
        };
        btn.setMaximumSize(new Dimension(500, 50));
        btn.setContentAreaFilled(false);
        btn.setBorderPainted(false);
        btn.setFocusPainted(false);
        btn.setCursor(new Cursor(Cursor.HAND_CURSOR));
        return btn;
    }

    private JPanel createOptionGroup(String[] options, ButtonGroup group, int btnWidth) {
        JPanel panel = new JPanel(new FlowLayout(FlowLayout.LEFT, 10, 5));
        panel.setOpaque(false);
        panel.setAlignmentX(Component.LEFT_ALIGNMENT);
        for (int i = 0; i < options.length; i++) {
            JToggleButton btn = createOptionButton(options[i], btnWidth);
            group.add(btn);
            panel.add(btn);
            if (i == 0) btn.setSelected(true);
        }
        return panel;
    }

    private JToggleButton createOptionButton(String text, int width) {
        JToggleButton btn = new JToggleButton(text) {
            @Override
            protected void paintComponent(Graphics g) {
                Graphics2D g2 = (Graphics2D) g.create();
                g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);
                g2.setColor(isSelected() ? SOFT_PINK_BG : Color.WHITE);
                g2.fillRoundRect(2, 2, getWidth() - 5, getHeight() - 5, 12, 12);
                g2.setColor(isSelected() ? PRIMARY_PINK : new Color(230, 230, 230));
                g2.setStroke(new BasicStroke(isSelected() ? 2.0f : 1.0f));
                g2.drawRoundRect(2, 2, getWidth() - 5, getHeight() - 5, 12, 12);
                g2.setColor(isSelected() ? PRIMARY_PINK : new Color(100, 100, 100));
                g2.setFont(new Font(CUTE_FONT, Font.BOLD, 14));
                FontMetrics fm = g2.getFontMetrics();
                g2.drawString(getText(), (getWidth() - fm.stringWidth(getText())) / 2, (getHeight() + fm.getAscent()) / 2 - 2);
                g2.dispose();
            }
        };
        btn.setPreferredSize(new Dimension(width, 40));
        btn.setContentAreaFilled(false);
        btn.setBorderPainted(false);
        btn.setFocusPainted(false);
        return btn;
    }

    private void addFormLabel(JPanel container, String text) {
        JLabel label = new JLabel(text);
        label.setFont(new Font(CUTE_FONT, Font.BOLD, 15));
        label.setForeground(new Color(70, 70, 70));
        label.setAlignmentX(Component.LEFT_ALIGNMENT);
        container.add(label);
        container.add(Box.createVerticalStrut(8));
    }

    private String getSelectedButtonText(ButtonGroup group) {
        for (Enumeration<AbstractButton> buttons = group.getElements(); buttons.hasMoreElements(); ) {
            AbstractButton button = buttons.nextElement();
            if (button.isSelected()) return button.getText();
        }
        return "";
    }
}
